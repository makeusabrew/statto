<!doctype html>
<html>
    <head>
        <title>Statto</title>
        <style type=text/css>
            .chart {
                position:relative;
                border:1px solid black;
                height:400px;
            }

            .median {
                position:absolute;
                width:100%;
                height:1px;
                background:black;
                top:-1px;
            }

            .point {
                width:7px;
                background:red;
                display:inline-block;
                border-right:1px solid #aaa;
            }
        </style>
    </head>
    <body>
        <div class=wrapper>
            <div class=chart>
                <div class=median></div>
            </div>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>
            var socket = io.connect();

            var currentMax = 0;
            var chart      = $(".chart");
            var maxHeight  = chart.height();
            var totalCount = 0;
            var totalMsec  = 0;
            socket.on("message", function(data) {
                var msec = data.msec;

                totalCount ++;
                totalMsec += msec;

                if (msec > currentMax) {
                    // rescale the entire graph
                    currentMax = msec;

                    $(".point").each(function() {
                        var cHeight = $(this).attr("data-msec");
                        var newHeight = (cHeight / currentMax) * maxHeight;
                        $(this).animate({
                            "height":newHeight
                        });
                        //$(this).height(newHeight);
                    });
                }


                //console.log(data);

                var height = (msec / currentMax) * maxHeight;

                var point = $("<div class=point></div>");
                point.attr("data-msec", msec);
                chart.append(point);
                /*
                point.animate({
                    "height": height
                });
                */
                point.hide();
                point.height(height);
                //point.slideDown("fast");
                point.fadeIn("slow");

                var median = totalMsec / totalCount;
                var pos = maxHeight - ((median / currentMax) * maxHeight);
                $(".median").css("top", pos+"px");
            });
        </script>
    </body>
</html>
