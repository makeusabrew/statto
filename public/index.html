<!doctype html>
<html>
    <head>
        <title>Statto</title>
        <style type=text/css>
            .chart {
                position:relative;
                border:1px solid black;
                height:400px;
            }

            .mean {
                position:absolute;
                width:100%;
                height:18px;
                top:-1px;
                border-bottom:1px solid blue;
                text-align:right;
            }

            .percentile {
                position:absolute;
                width:100%;
                height:18px;
                top:-1px;
                border-bottom:1px solid green;
                text-align:right;
            }

            .point {
                width:7px;
                background:gray;
                display:inline-block;
                border-right:1px solid #aaa;
            }
        </style>
    </head>
    <body>
        <div class=wrapper>
            <div class=chart>
                <div class=mean>Avg: <span>-</span></div>
                <div class=percentile>98th: <span>-</span></div>
            </div>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>
            var socket = io.connect();

            var currentMax = 0;
            var chart      = $(".chart");
            var maxHeight  = chart.height();
            var totalCount = 0;
            var totalMsec  = 0;
            var readings   = [];

            var percentile = function(N, P) {
                //
                var n = parseInt(Math.round(P * N.length + 0.5));
                if (n > 1) {
                    return N[n-2];
                }
                return 0;
            }

            socket.on("message", function(data) {
                var msec = data.msec;

                totalCount ++;
                totalMsec += msec;

                readings.push(msec);

                if (msec > currentMax) {
                    // rescale the entire graph
                    currentMax = msec;

                    $(".point").each(function() {
                        var cHeight = $(this).attr("data-msec");
                        var newHeight = (cHeight / currentMax) * maxHeight;
                        $(this).animate({
                            "height":newHeight
                        });
                        //$(this).height(newHeight);
                    });
                }


                //console.log(data);

                var height = (msec / currentMax) * maxHeight;

                var point = $("<div class=point></div>");
                point.attr("data-msec", msec);
                chart.append(point);
                /*
                point.animate({
                    "height": height
                });
                */
                point.hide();
                point.height(height);
                //point.slideDown("fast");
                point.fadeIn("slow");

                var mean = totalMsec / totalCount;
                var pos = maxHeight - ((mean / currentMax) * maxHeight);
                pos -= 18;
                $(".mean").css("top", pos+"px");
                $(".mean span").text(Math.round(mean, 1));

                var pc = percentile(readings.sort(), 0.98);

                var pos = maxHeight - ((pc / currentMax) * maxHeight);
                pos -= 18;
                $(".percentile").css("top", pos+"px");
                $(".percentile span").text(Math.round(pc, 1));
            });
        </script>
    </body>
</html>
